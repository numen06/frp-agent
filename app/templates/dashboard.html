<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表板 - frp-agent 管理系统</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <h1>🚀 frp-agent 管理系统</h1>
            <div class="user-info">
                <span id="usernameDisplay">管理员</span>
                <a href="/settings" class="btn btn-secondary btn-small" style="margin-left: 10px;">⚙️ 设置</a>
                <button class="btn btn-danger btn-small" onclick="handleLogout()" style="margin-left: 10px;">退出登录</button>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container">
        <!-- 服务器选择和管理 -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                    <h2 style="margin: 0;">当前服务器：</h2>
                    <select id="currentServerSelect" onchange="switchServer()" style="padding: 0.5rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; min-width: 200px;">
                        <option value="">请选择服务器...</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="testCurrentServer()">测试连接</button>
                </div>
                <button class="btn btn-primary" onclick="openModal('serverManageModal')">📋 管理服务器</button>
            </div>
            <div id="currentServerInfo"></div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <h3>代理总数</h3>
                <div class="value" id="proxyCount">0</div>
            </div>
            <div class="stat-card">
                <h3>在线代理</h3>
                <div class="value" id="onlineCount">0</div>
            </div>
            <div class="stat-card">
                <h3>离线代理</h3>
                <div class="value" id="offlineCount">0</div>
            </div>
            <div class="stat-card">
                <h3>端口分配</h3>
                <div class="value" id="portCount">0</div>
            </div>
        </div>

        <!-- 代理与分组管理 - Tab模式 -->
        <div class="card">
            <!-- 标签页导航 -->
            <div class="tabs" style="margin-bottom: 1.5rem;">
                <button class="tab-btn active" onclick="switchMainTab('proxies')">📋 代理列表</button>
                <button class="tab-btn" onclick="switchMainTab('groups')">📁 分组管理</button>
            </div>
            
            <!-- 代理列表标签页 -->
            <div id="proxiesTab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <!-- 分组过滤 -->
                        <select id="groupFilter" onchange="applyFilters()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            <option value="">全部分组</option>
                        </select>
                        
                        <!-- 状态过滤 -->
                        <select id="statusFilter" onchange="applyFilters()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            <option value="">全部状态</option>
                            <option value="online">在线</option>
                            <option value="offline">离线</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="showImportConfigModal()">📤 导入配置</button>
                    <button class="btn btn-primary" onclick="refreshProxies()">🔄 刷新</button>
                    </div>
                </div>
                
                <!-- 分析信息展示 -->
                <div id="analysisInfo" style="margin-bottom: 1rem;"></div>
                
                <!-- 批量操作工具栏 -->
                <div id="bulkActionBar" style="display: none; background: #f3f4f6; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <span id="selectedCount" style="font-weight: 600; color: #374151;">已选择 0 个代理</span>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <select id="bulkGroupSelect" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; min-width: 150px;">
                                <option value="">选择目标分组...</option>
                            </select>
                            <button class="btn btn-primary" onclick="bulkAssignGroup()">分配到分组</button>
                            <button class="btn btn-success" onclick="generateConfigForSelected()">⚙️ 生成配置</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">取消选择</button>
                        </div>
                    </div>
                </div>
                
                <div id="proxiesTable"></div>
            </div>
            
            <!-- 分组管理标签页 -->
            <div id="groupsTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <p style="color: #6b7280; margin: 0;">管理所有代理分组，支持重命名和快速生成配置</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openCreateGroupModal()">➕ 新增分组</button>
                        <button class="btn btn-success" onclick="autoAnalyzeGroups()">🔍 自动分析分组</button>
                    </div>
                </div>
                <div id="groupsManageTable"></div>
            </div>
        </div>
    </div>

    <!-- 服务器管理 Modal -->
    <div id="serverManageModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>服务器管理</h2>
                <span class="close-btn" onclick="closeModal('serverManageModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="openModal('addServerModal')">+ 添加服务器</button>
            </div>
            <div id="serversTable"></div>
        </div>
    </div>

    <!-- 添加服务器 Modal -->
    <div id="addServerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加 frps 服务器</h2>
                <span class="close-btn" onclick="closeModal('addServerModal')">&times;</span>
            </div>
            <form id="serverForm" onsubmit="submitServer(event)">
                <div class="form-group">
                    <label>服务器名称</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>服务器地址</label>
                    <input type="text" name="server_addr" id="server_addr" required onchange="generateApiUrl()">
                </div>
                <div class="form-group">
                    <label>服务器端口</label>
                    <input type="number" name="server_port" value="7000" required>
                </div>
                <div class="form-group">
                    <label>API 基础地址 <small style="color: #6b7280;">(可自动生成或手动修改)</small></label>
                    <input type="text" name="api_base_url" id="api_base_url" required placeholder="http://frp.51jbm.cn/api">
                </div>
                <div class="form-group">
                    <label>认证用户名</label>
                    <input type="text" name="auth_username" value="admin" required>
                </div>
                <div class="form-group">
                    <label>认证密码</label>
                    <input type="password" name="auth_password" required>
                </div>
                <div class="form-group">
                    <label>认证 Token <small style="color: #6b7280;">(可选，如果配置了 token 则使用 token 认证)</small></label>
                    <input type="text" name="auth_token" placeholder="留空表示使用用户名密码认证">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="testServerConnection()">测试连接</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑服务器 Modal -->
    <div id="editServerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑 frps 服务器</h2>
                <span class="close-btn" onclick="closeModal('editServerModal')">&times;</span>
            </div>
            <form id="editServerForm" onsubmit="submitEditServer(event)">
                <input type="hidden" name="id" id="edit_server_id">
                <div class="form-group">
                    <label>服务器名称</label>
                    <input type="text" name="name" id="edit_name" required>
                </div>
                <div class="form-group">
                    <label>服务器地址</label>
                    <input type="text" name="server_addr" id="edit_server_addr" required onchange="generateEditApiUrl()">
                </div>
                <div class="form-group">
                    <label>服务器端口</label>
                    <input type="number" name="server_port" id="edit_server_port" required>
                </div>
                <div class="form-group">
                    <label>API 基础地址 <small style="color: #6b7280;">(可自动生成或手动修改)</small></label>
                    <input type="text" name="api_base_url" id="edit_api_base_url" required>
                </div>
                <div class="form-group">
                    <label>认证用户名</label>
                    <input type="text" name="auth_username" id="edit_auth_username" required>
                </div>
                <div class="form-group">
                    <label>认证密码 <small style="color: #6b7280;">(留空表示不修改)</small></label>
                    <input type="password" name="auth_password" id="edit_auth_password">
                </div>
                <div class="form-group">
                    <label>认证 Token <small style="color: #6b7280;">(可选，如果配置了 token 则使用 token 认证)</small></label>
                    <input type="text" name="auth_token" id="edit_auth_token" placeholder="留空表示使用用户名密码认证">
                </div>
                <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="testEditServerConnection()">测试连接</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 创建/编辑分组 Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="groupModalTitle">重命名分组</h2>
                <span class="close-btn" onclick="closeModal('groupModal')">&times;</span>
            </div>
            <form id="groupForm" onsubmit="submitGroupForm(event)">
                <input type="hidden" id="groupOldName">
                <div class="form-group">
                    <label>分组名称</label>
                    <input type="text" id="groupNewName" required placeholder="输入分组名称">
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>

    <!-- 生成配置 Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>⚙️ 生成 frpc 配置</h2>
                <span class="close-btn" onclick="closeModal('configModal')">&times;</span>
            </div>
            
            <div id="selectedProxiesInfo" style="margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.375rem;">
                <strong>已选择的代理：</strong>
                <div id="selectedProxiesList" style="margin-top: 0.5rem;"></div>
            </div>
            
            <div class="form-group">
                <label>配置名称（可选）</label>
                <input type="text" id="configClientName" placeholder="留空则使用分组名称">
            </div>
            
            <div class="form-group">
                <label>配置格式</label>
                <select id="configFormat" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; width: 100%;">
                    <option value="ini">INI 格式（兼容旧版本 FRP）</option>
                    <option value="toml">TOML 格式（推荐，新版本 FRP）</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="generateConfigFromSelected()">📄 生成配置文件</button>
                <button class="btn btn-secondary" onclick="downloadConfigFile()">💾 下载配置</button>
            </div>
            
            <div id="configOutput" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- 编辑代理 Modal -->
    <div id="editProxyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ 编辑代理</h2>
                <span class="close-btn" onclick="closeModal('editProxyModal')">&times;</span>
            </div>
            <form id="editProxyForm" onsubmit="submitEditProxy(event)">
                <input type="hidden" id="edit_proxy_id" name="proxy_id">
                
                <div class="form-group">
                    <label>代理名称 *</label>
                    <input type="text" id="edit_proxy_name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label>分组名称</label>
                    <input type="text" id="edit_group_name" name="group_name" placeholder="留空则自动从名称解析">
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        如留空，系统将从代理名称自动解析分组（例如: dlyy_rdp → dlyy）
                    </small>
                </div>
                
                <div class="form-group">
                    <label>代理类型 *</label>
                    <select id="edit_proxy_type" name="proxy_type" required>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="stcp">STCP</option>
                        <option value="xtcp">XTCP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>本地 IP *</label>
                    <input type="text" id="edit_local_ip" name="local_ip" value="127.0.0.1" required>
                </div>
                
                <div class="form-group">
                    <label>本地端口 *</label>
                    <input type="number" id="edit_local_port" name="local_port" min="1" max="65535" required>
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        本地服务的端口号（1-65535）
                    </small>
                </div>
                
                <div class="form-group">
                    <label>远程端口</label>
                    <input type="number" id="edit_remote_port" name="remote_port" min="1" max="65535" placeholder="TCP/UDP 类型需要">
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        frps 服务器上的端口号（TCP/UDP 类型必填）
                    </small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">保存修改</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editProxyModal')">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 分组生成配置 Modal -->
    <div id="groupConfigModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>⚙️ 生成分组配置</h2>
                <span class="close-btn" onclick="closeModal('groupConfigModal')">&times;</span>
            </div>
            
            <div id="groupConfigInfo" style="margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.375rem;">
                <strong>分组：</strong><span id="groupConfigName" style="margin-left: 0.5rem; color: #3b82f6; font-weight: 600;"></span>
                <div style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    将为该分组的所有代理生成配置文件
                </div>
            </div>
            
            <div class="form-group">
                <label>配置格式</label>
                <select id="groupConfigFormat" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; width: 100%;">
                    <option value="ini">INI 格式（兼容旧版本 FRP）</option>
                    <option value="toml">TOML 格式（推荐，新版本 FRP）</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="generateGroupConfigFromModal()">📄 生成配置文件</button>
                <button class="btn btn-secondary" onclick="downloadGroupConfigFile()">💾 下载配置</button>
            </div>
            
            <div id="groupConfigOutput" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- 新增分组 Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ 新增分组</h2>
                <span class="close-btn" onclick="closeModal('createGroupModal')">&times;</span>
            </div>
            <form id="createGroupForm" onsubmit="submitCreateGroup(event)">
                <div class="form-group">
                    <label>分组名称 *</label>
                    <input type="text" id="new_group_name" name="group_name" required placeholder="例如: dlyy">
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        输入新分组的名称，之后可以将代理分配到此分组
                    </small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">创建分组</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createGroupModal')">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除分组 Modal -->
    <div id="deleteGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🗑️ 删除分组</h2>
                <span class="close-btn" onclick="closeModal('deleteGroupModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <p style="color: #374151; margin-bottom: 0.5rem;">
                    确定要删除分组 <strong id="delete_group_name_display" style="color: #ef4444;"></strong> 吗？
                </p>
                <p style="color: #6b7280; font-size: 0.875rem;">
                    该分组下有 <strong id="delete_group_proxy_count"></strong> 个代理。
                </p>
            </div>
            
            <form id="deleteGroupForm" onsubmit="submitDeleteGroup(event)">
                <input type="hidden" id="delete_group_name" name="group_name">
                
                <div class="form-group">
                    <label>处理方式 *</label>
                    <select id="delete_reassign_group" name="reassign_group" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        <option value="">移动到"其他"分组</option>
                    </select>
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        选择将这些代理移动到哪个分组
                    </small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deleteGroupModal')">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 导入配置文件 Modal -->
    <div id="importConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📤 导入 frpc 配置文件</h2>
                <span class="close-btn" onclick="closeModal('importConfigModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <p style="color: #6b7280; margin-bottom: 1rem;">
                    上传 frpc 配置文件（INI 或 TOML 格式），系统将自动解析并导入代理信息。
                    <br>对于已存在的代理，将完全覆盖更新；对于新的代理，将创建新记录。
                </p>
            </div>
            
            <form id="importConfigForm" onsubmit="importConfig(event)">
                <div class="form-group">
                    <label>当前服务器</label>
                    <input type="text" id="importServerDisplay" readonly style="background: #f3f4f6; width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                </div>
                
                <div class="form-group">
                    <label>选择分组 *</label>
                    <select id="importGroupSelect" name="group_name" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        <option value="">请选择分组...</option>
                    </select>
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        导入的代理将被分配到此分组
                    </small>
                </div>
                
                <div class="form-group">
                    <label>选择配置文件 *</label>
                    <input type="file" id="configFile" name="file" accept=".ini,.toml" required 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                        支持 .ini 和 .toml 格式的 frpc 配置文件
                    </small>
                </div>
                
                <div id="importProgress" style="display: none; margin: 1rem 0;">
                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #374151;">正在导入配置文件...</p>
                    </div>
                </div>
                
                <div id="importResult" style="display: none; margin: 1rem 0;"></div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" id="importSubmitBtn">开始导入</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importConfigModal')">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/group_manage.js"></script>
</body>
</html>

