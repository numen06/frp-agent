# 自动端口识别功能使用说明

## 功能概述

在代理列表中新增了自动识别本地端口的功能。当本地端口设置为 0 或留空时，系统会根据代理名称自动识别并设置合适的端口号。

## 支持的服务类型

系统支持以下常见服务的自动端口识别：

### 远程访问
- **RDP** (Remote Desktop): 3389 - 关键字: `rdp`, `mstsc`, `remote`
- **SSH**: 22 - 关键字: `ssh`
- **SFTP**: 22 - 关键字: `sftp`
- **VNC**: 5900 - 关键字: `vnc`

### Web 服务
- **HTTP**: 80 - 关键字: `http`, `web`, `nginx`, `apache`
- **HTTPS**: 443 - 关键字: `https`

### 容器与容器编排
- **Docker**: 9000 - 关键字: `docker`

### 数据库
- **MySQL/MariaDB**: 3306 - 关键字: `mysql`, `mariadb`
- **PostgreSQL**: 5432 - 关键字: `postgres`, `postgresql`, `pgsql`
- **MongoDB**: 27017 - 关键字: `mongo`, `mongodb`
- **Redis**: 6379 - 关键字: `redis`
- **Elasticsearch**: 9200 - 关键字: `elasticsearch`, `es`

### 邮件服务
- **SMTP**: 25 - 关键字: `smtp`
- **SMTPS**: 465 - 关键字: `smtps`
- **IMAP**: 143 - 关键字: `imap`
- **IMAPS**: 993 - 关键字: `imaps`
- **POP3**: 110 - 关键字: `pop3`
- **POP3S**: 995 - 关键字: `pop3s`

### 其他常用服务
- **FTP**: 21 - 关键字: `ftp`
- **DNS**: 53 - 关键字: `dns`
- **NTP**: 123 - 关键字: `ntp`
- **Grafana**: 3000 - 关键字: `grafana`
- **Kibana**: 5601 - 关键字: `kibana`
- **Prometheus**: 9090 - 关键字: `prometheus`
- **Jenkins**: 8080 - 关键字: `jenkins`
- **Tomcat**: 8080 - 关键字: `tomcat`

### 游戏服务器
- **Minecraft**: 25565 - 关键字: `minecraft`, `mc`
- **CS:GO**: 27015 - 关键字: `csgo`, `cs`
- **Terraria**: 7777 - 关键字: `terraria`

## 使用方法

### 方法一：批量识别端口（推荐）🔥

一键识别所有本地端口为 0 的代理，最快捷高效的方式！

**操作步骤：**
1. 登录系统，选择目标服务器
2. 点击代理列表页面右上角的 **"🔍 批量识别端口"** 按钮
3. 确认批量识别操作
4. 系统自动扫描并识别所有端口为 0 的代理
5. 弹出详细结果报告，显示：
   - 📊 识别统计（总计/成功/失败）
   - ✅ 成功识别的代理列表及端口
   - ❌ 无法识别的代理列表（需手动设置）

**适用场景：**
- 批量导入配置后，统一识别所有端口
- 迁移旧数据时，批量更新端口信息
- 定期检查并修复端口为 0 的代理

**API 接口：**
```bash
POST /api/proxies/batch-detect-ports?frps_server_id={id}
```

### 方法二：代理名称包含关键字

直接在代理名称中包含上述关键字即可自动识别端口。

**示例：**
- `dlyy_rdp` → 自动识别为端口 3389
- `server_ssh` → 自动识别为端口 22
- `web_http` → 自动识别为端口 80
- `app_docker` → 自动识别为端口 9000
- `db_mysql` → 自动识别为端口 3306

### 方法三：代理名称末尾包含端口号

如果代理名称以下划线加端口号结尾，会优先使用该端口。

**示例：**
- `dlyy_app_8080` → 使用端口 8080
- `service_custom_9999` → 使用端口 9999
- `api_server_3000` → 使用端口 3000

### 方法四：在编辑代理时输入 0

在编辑代理时，如果将本地端口设置为 0，系统会根据代理名称自动识别端口。

## 匹配规则

系统采用以下优先级进行匹配：

1. **端口号后缀优先**：如果代理名称末尾包含 `_数字` 格式，直接使用该端口
2. **完整单词匹配**：优先匹配以下划线分隔的完整关键字
3. **部分包含匹配**：如果没有完整匹配，则检查是否包含关键字
4. **长关键字优先**：对于可能重叠的关键字（如 `http` 和 `https`），优先匹配较长的关键字

## 前后端实现

### 后端实现

在 `app/models/proxy.py` 中的 `Proxy.auto_detect_local_port()` 静态方法实现：

```python
# 创建代理时，如果 local_port 为 0
detected_port = Proxy.auto_detect_local_port(proxy_name)
```

### 前端实现

在 `app/static/js/dashboard.js` 中的 `autoDetectLocalPort()` 函数实现，编辑代理时实时识别：

- 当修改代理名称时，如果端口为 0，自动填充识别到的端口
- 提交时，如果端口为 0，尝试自动识别

## 注意事项

1. **无法识别时的处理**：如果代理名称中没有可识别的关键字，且端口为 0，系统会提示错误，要求手动指定端口
2. **可手动修改**：自动识别的端口可以随时手动修改
3. **关键字大小写不敏感**：`RDP`、`rdp`、`Rdp` 都能正确识别
4. **关键字位置灵活**：关键字可以出现在代理名称的任何位置

## 示例场景

### 场景 1：快速配置多个标准服务

```
dlyy_rdp    → 3389
dlyy_ssh    → 22
dlyy_http   → 80
dlyy_mysql  → 3306
```

只需要设置代理名称，本地端口自动识别，无需手动输入。

### 场景 2：自定义端口服务

```
dlyy_app_8080     → 8080
dlyy_api_3000     → 3000
dlyy_custom_9999  → 9999
```

在代理名称末尾添加端口号，系统自动使用该端口。

### 场景 3：批量导入配置

在导入 INI/TOML 配置时，如果配置中的本地端口为 0，系统会自动根据代理名称识别端口。

## 技术细节

- 后端使用正则表达式进行匹配，支持单词边界识别
- 前端使用 JavaScript 正则表达式实现相同逻辑
- 前后端端口映射表完全一致，确保行为统一
- 支持动态提示，编辑时实时显示识别结果

## 更新日志

- **2024-11-08**: 初始版本发布
  - 支持 40+ 种常见服务的自动端口识别
  - 支持完整单词匹配和部分包含匹配
  - 支持端口号后缀识别
  - 前后端统一实现

